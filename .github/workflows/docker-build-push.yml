name: Build and Push Docker Image
on:
  push:
    branches: [ "main" ]
    paths:
      - '.version'
  pull_request:
    branches: [ "main" ]
    paths:
      - '.version'workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract project info
        id: info
        run: |
          PROJECT_NAME=$(grep'^project_name=' .version | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          VERSION=$(grep '^version=' .version | cut -d'=' -f2)
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "REPO_OWNER=$REPO_OWNER" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TAG=v${VERSION}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-7)
            echo "TAG=v${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.arch }} \
            go build -ldflags='-s -w' -o kiro-${{ matrix.arch }} ./cmd/server

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          IMAGE=ghcr.io/${{ steps.info.outputs.REPO_OWNER }}/${{ steps.info.outputs.PROJECT_NAME }}

          cat > Dockerfile.ci <<EOF
          FROM scratch
          COPY --from=alpine:latest /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
          COPY kiro-${{ matrix.arch }} /kiro
          EXPOSE 1188
          ENTRYPOINT ["/kiro"]
          EOF

          docker buildx build \
            --platform linux/${{ matrix.arch }} \
            --provenance=false \
            -f Dockerfile.ci \
            -t ${IMAGE}:${{ steps.info.outputs.TAG }}-${{ matrix.arch }} \
            --push \
            .

      - name: Save image info
        run: |
          echo "${{ steps.info.outputs.TAG }}" > tag.txt
          echo "${{ steps.info.outputs.PROJECT_NAME }}" > project.txt
          echo "${{ steps.info.outputs.REPO_OWNER }}" > owner.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: info-${{ matrix.arch }}
          path: |
            tag.txt
            project.txt
            owner.txt

  create-manifest:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: info-amd64

      - name: Read info
        id: info
        run: |
          echo "TAG=$(cat tag.txt)" >> $GITHUB_OUTPUT
          echo "PROJECT_NAME=$(cat project.txt)" >> $GITHUB_OUTPUT
          echo "REPO_OWNER=$(cat owner.txt)" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          IMAGE=ghcr.io/${{ steps.info.outputs.REPO_OWNER }}/${{ steps.info.outputs.PROJECT_NAME }}
          TAG=${{ steps.info.outputs.TAG }}

          docker manifest create ${IMAGE}:${TAG} \
            ${IMAGE}:${TAG}-amd64 \
            ${IMAGE}:${TAG}-arm64

          docker manifest create ${IMAGE}:latest \
            ${IMAGE}:${TAG}-amd64 \
            ${IMAGE}:${TAG}-arm64

          docker manifest push ${IMAGE}:${TAG}
          docker manifest push ${IMAGE}:latest

          echo "Multi-arch manifest pushed!"
          echo "  - ${IMAGE}:${TAG}"
          echo "  - ${IMAGE}:latest"
